#
# Makefile.fpc for Free Pascal Tests directory
#

[install]
fpcpackage=y

[default]
fpcdir=..
rule=allexectests

[rules]
unexport FPC_VERSION

################################
# Test environment setup
#

ifndef TEST_FPC
#Use development version of the compiler
TEST_FPC=$(wildcard $(dir $(CURDIR))compiler/$(notdir $(FPC)))
ifeq ($(TEST_FPC), )
$(error "*** ERROR: TEST_FPC is missing ***")
endif
endif

#Defaults *not* to OPT
ifndef TEST_OPT
TEST_OPT=
endif

# Retrieve Test compiler info
ifndef TEST_FPC_VERSION
TEST_FPC_COMPILERINFO:=$(shell $(TEST_FPC) -iVSPTPSOTO)
TEST_FPC_VERSION:=$(word 1,$(TEST_FPC_COMPILERINFO))
endif
export TEST_FPC TEST_FPC_VERSION TEST_FPC_COMPILERINFO
ifneq ($(words $(TEST_FPC_COMPILERINFO)),5)
TEST_FPC_COMPILERINFO+=$(shell $(TEST_FPC) -iSP)
TEST_FPC_COMPILERINFO+=$(shell $(TEST_FPC) -iTP)
TEST_FPC_COMPILERINFO+=$(shell $(TEST_FPC) -iSO)
TEST_FPC_COMPILERINFO+=$(shell $(TEST_FPC) -iTO)
endif
ifndef TEST_CPU_SOURCE
TEST_CPU_SOURCE:=$(word 2,$(TEST_FPC_COMPILERINFO))
endif
ifndef TEST_CPU_TARGET
TEST_CPU_TARGET:=$(word 3,$(TEST_FPC_COMPILERINFO))
endif
ifndef TEST_OS_SOURCE
TEST_OS_SOURCE:=$(word 4,$(TEST_FPC_COMPILERINFO))
endif
ifndef TEST_OS_TARGET
TEST_OS_TARGET:=$(word 5,$(TEST_FPC_COMPILERINFO))
endif

ifndef TEST_CCOMPILER
ifeq ($(CPU_TARGET),$(TEST_CPU_TARGET))
ifeq ($(OS_TARGET),$(TEST_OS_TARGET))
TEST_CCOMPILER:=$(strip $(wildcard $(addsuffix /gcc$(SRCEXEEXT),$(SEARCHPATH))))
ifneq ($(TEST_CCOMPILER),)
TEST_CCOMPILER:=$(firstword $(TEST_CCOMPILER))
endif
endif
endif
endif


################################
# Misc
#

ifndef FAILLIST
export FAILLIST:=faillist
endif

ifndef LONGLOG
export LONGLOG:=longlog
endif

ifndef LOG
export LOG:=log
endif


# Subdirs available in the test subdir
TESTSUBDIRS=cg cg/cdecl units/system units/dos units/crt units/objects units/strings units/sysutils units/math

# All full dirnames in the test/ dir including the subdir self
TESTDIRS:=test $(addprefix test/,$(TESTSUBDIRS))

# Unix like OS ?
ifneq ($(findstring $(TEST_OS_TARGET),$(UNIXs)),)
INUNIX=1
endif

# For unixes by default no graph tests
ifdef INUNIX
NOGRAPH=1
endif

.PHONY: utils units copyfiles testprep

################################
# Utilities
#

utils:
        $(MAKE) -C utils


ifeq ($(USESQL),YES)
ifndef DBDIGEST
DBDIGEST=utils/dbdigest
endif
endif

ifndef DIGEST
DIGEST=utils/digest
endif

ifndef DOTEST
DOTEST=utils/dotest
endif

ifneq ($(wildcard utils/testfail$(SRCEXEEXT)),)
#BUG: This will not run first time for a fresh tests dir:
TESTCOMSPECRES:=$(shell utils/testfail$(SRCEXEEXT))
else
$(warning "*** WARNING testfail did not run ***")
endif

ifneq ($(TESTCOMSPECRES),)
NOCOMSPEC=1
endif

################################
# Units
#

units:
        $(MAKE) -C units FPC=$(TEST_FPC) CPU_TARGET=$(TEST_CPU_TARGET) OS_TARGET=$(TEST_OS_TARGET) \
                         OPT="$(TEST_OPT)" CCOMPILER=$(TEST_CCOMPILER) BINUTILSPREFIX=$(TEST_BINUTILSPREFIX)

################################
# Copy test environment dependent files ctest.o to test/cg etc
#

copyfiles:
        $(COPY) test/cg/obj/$(TEST_OS_TARGET)/$(TEST_CPU_TARGET)/ctest.o test/cg
        $(COPY) test/units/system/test*.txt .

################################
# Preparation for tests
#

testprep: testprep-stamp.$(TEST_OS_TARGET)
testprep-stamp.$(TEST_OS_TARGET): utils units copyfiles
        $(ECHO) $(DATE) > testprep-stamp.$(TEST_OS_TARGET)


################################
# Dotest options
#

ifneq ($(TEST_FPC),ppc386$(EXEEXT))
ifeq ($(findstring -c$(TEST_FPC),$(DOTESTOPT)),)
override DOTESTOPT+=-c$(TEST_FPC)
endif
endif

ifneq ($(OS_TARGET),$(TEST_OS_TARGET))
override DOTESTOPT+=-Y-T$(TEST_OS_TARGET)
endif
ifneq ($(OS_TARGET),$(TEST_BINUTILSPREFIX))
override DOTESTOPT+=-Y-XP$(TEST_BINUTILSPREFIX)
endif
ifdef TEST_RSH
override DOTESTOPT+=-R$(TEST_RSH)
endif
ifdef TEST_SSH
override DOTESTOPT+=-R$(TEST_SSH) -S
endif
ifdef TEST_REMOTEPATH
override DOTESTOPT+=-P$(TEST_REMOTEPATH)
endif
ifdef TEST_DELTEMP
override DOTESTOPT+=-T
endif
ifdef TEST_VERBOSE
override DOTESTOPT+=-V
endif
ifdef TEST_REMOTEOPT
override DOTESTOPT+="-U$(TEST_REMOTEOPT)"
endif
ifdef TEST_PUTTY
override DOTESTOPT+=-R$(TEST_PUTTY) -W
endif

ifdef TEST_OPT
#  handles several options as well
override DOTESTOPT+=$(addprefix -Y, $(TEST_OPT))
endif

ifdef TEST_REMOTEPW
#  handles several options as well
override DOTESTOPT+=-U-pw -U$(TEST_REMOTEPW)
endif


ifdef GRAPH
override DOTESTOPT+=-g
endif

ifdef INTERACTIVE
override DOTESTOPT+=-i
endif

ifdef DOALL
override DOTESTOPT+=-a
endif

ifdef NOCOMSPEC
override DOTESTOPT+=-x
endif


################################
# Run tests
#

DIRS=webtbs webtbf tbs tbf $(TESTDIRS)

%.log : %.pp
        $(DOTEST) $(DOTESTOPT) $<

%.elg : %.pp
        $(DOTEST) $(DOTESTOPT) -e $<


################################
# Compile tests
#

.PHONY: alltbs alltbf allwebtbs allwebtbf alltest alltests

alltbs : testprep $(patsubst %.pp,%.log,$(wildcard tbs/t*.pp))
alltbf : testprep $(patsubst %.pp,%.log,$(wildcard tbf/t*.pp))

allwebtbs : testprep $(patsubst %.pp,%.log,$(wildcard webtbs/t*.pp))
allwebtbf : testprep $(patsubst %.pp,%.log,$(wildcard webtbf/t*.pp))

alltest : testprep $(patsubst %.pp,%.log,$(wildcard $(addsuffix /t*.pp,$(TESTDIRS))))

alltests: alltest alltbs alltbf allwebtbs allwebtbf

################################
# Compile and Run tests
#

.PHONY: allexectbs allexectbf allexecwebtbs allexecwebtbf allexectest allexectests

allexectbs : testprep $(patsubst %.pp,%.elg,$(wildcard tbs/t*.pp))
allexectbf : testprep $(patsubst %.pp,%.elg,$(wildcard tbf/t*.pp))

allexecwebtbs : testprep $(patsubst %.pp,%.elg,$(wildcard webtbs/t*.pp))
allexecwebtbf : testprep $(patsubst %.pp,%.elg,$(wildcard webtbf/t*.pp))

allexectest : testprep $(patsubst %.pp,%.elg,$(wildcard $(addsuffix /t*.pp,$(TESTDIRS))))

allexectests: allexectest allexectbs allexectbf allexecwebtbs allexecwebtbf

################################
# Clean
#

.PHONY: clean distclean clean_test

clean_test:
        -$(DEL) $(addsuffix /*$(PPUEXT),$(DIRS))
        -$(DEL) $(addsuffix /*$(OEXT),$(DIRS))
        -$(DEL) $(addsuffix /*.rst,$(DIRS))
        -$(DEL) $(addsuffix /*$(SHAREDLIBEXT),$(DIRS))
        -$(DEL) $(addsuffix /*.log,$(DIRS))
        -$(DEL) $(addsuffix /*.elg,$(DIRS))
        -$(DEL) $(addsuffix /*$(ASMEXT),$(DIRS))
        -$(DEL) $(addsuffix /*_ppas$(BATCHEXT),$(DIRS))
ifeq ($(EXEEXT),)
        -$(DEL) $(wildcard $(patsubst %.pp,%$(EXEEXT),$(wildcard $(addsuffix /t*.pp,$(DIRS)))))
else
        -$(DEL) $(addsuffix /*$(EXEEXT),$(DIRS))
endif
ifdef DEBUGSYMEXT
        -$(DEL) $(addsuffix /*$(DEBUGSYMEXT),$(DIRS))
endif
        -$(DEL) test*.txt *.tmp *$(SHAREDLIBEXT) *$(OEXT) *$(PPUEXT) core
        -$(DEL) $(LOG) $(LONGLOG) $(FAILLIST)
        -$(DEL) ppas$(SRCBATCHEXT) gmon.out testprep-stamp.*
#          Needed when link on target:
        -$(DEL) *_ppas$(BATCHEXT)


clean:
        $(MAKE) clean_test CPU_TARGET=$(TEST_CPU_TARGET) OS_TARGET=$(TEST_OS_TARGET)
        $(MAKE) -C units clean CPU_TARGET=$(TEST_CPU_TARGET) OS_TARGET=$(TEST_OS_TARGET)

distclean: clean
        $(MAKE) -C utils clean

cleanall: clean
        $(MAKE) -C utils cleanall

################################
# Main rules
#

.PHONY: all full rundigest dailytest onlyknown onlygraph onlyinteractive

rundigest : utils
        -$(DIGEST)
ifeq ($(USESQL),YES)
        -$(DBDIGEST) -v $(TEST_FPC_VERSION) -o $(TEST_OS_TARGET) -c $(TEST_CPU_TARGET) $(DBDIGESTOPT)
endif

all : allexectests

full : clean allexectests rundigest

onlyknown :
        $(MAKE) full "DOTESTOPT= $(DOTESTOPT) -k-"

onlygraph :
        $(MAKE) full "DOTESTOPT= $(DOTESTOPT) -g-"

onlyinteractive :
        $(MAKE) "DOTESTOPT= $(DOTESTOPT) -i-"

info :
        @$(ECHO) This Makefile allows to test the compiler
        @$(ECHO)
        @$(ECHO) Targets:
        @$(ECHO) "  all   - continue all tests"
        @$(ECHO) "  full  - clean and run all tests"
        @$(ECHO) "  dailytest - run full and save results"
        @$(ECHO) "              in files having the date as extension"
        @$(ECHO) "  onlyknown - run only known bugs"
        @$(ECHO) "  onlygraph - run only graph tests"
        @$(ECHO) "  onlyinteractive - run only interactive tests"
        @$(ECHO) "  rundigest - compute and print test statistics"
        @$(ECHO)
        @$(ECHO) Driver environment:
        @$(ECHO) "  $(OS_TARGET)-$(CPU_TARGET)"
        @$(ECHO) "  compiler: $(FPC) ver: $(FPC_VERSION)"
ifdef COMSPEC
        @$(ECHO) "  and using COMSPEC=$(COMSPEC)"
endif
        @$(ECHO)
        @$(ECHO) Test environment:
        @$(ECHO) "  $(TEST_OS_TARGET)-$(TEST_CPU_TARGET)"
        @$(ECHO) "  compiler: $(TEST_FPC) ver: $(TEST_FPC_VERSION)"

override DATESUFFIX:=$(shell $(DATE) +%Y.%m.%d)

ifneq ($(wildcard log.$(DATESUFFIX)),)
override DATESUFFIX=$(shell $(DATE) +%Y.%m.%d.%H.%M)
endif

ifneq ($(wildcard lastdate.txt),)
LASTDATESUFFIX:=$(shell cat lastdate.txt)
endif


dailytest : full
        $(COPY) faillist faillist.$(DATESUFFIX)
        $(COPY) log log.$(DATESUFFIX)
        $(COPY) longlog longlog.$(DATESUFFIX)
        -$(DIGEST) > digest.$(DATESUFFIX)
ifdef LASTDATESUFFIX
        -diff -u log.$(LASTDATESUFFIX) log.$(DATESUFFIX) > difflog.$(DATESUFFIX)
        -diff -u digest.$(LASTDATESUFFIX) digest.$(DATESUFFIX) > diffdigest.$(DATESUFFIX)
        -diff -u faillist.$(LASTDATESUFFIX) faillist.$(DATESUFFIX) > difflist.$(DATESUFFIX)
endif
        @$(ECHO) $(DATESUFFIX) > lastdate.txt
